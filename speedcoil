-- AutoSpawn SpeedCoil on respawn (LocalScript)
-- Taruh di StarterPlayer -> StarterPlayerScripts

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Fungsi yang membuat/menaruh SpeedCoil ke Backpack (client-side)
local function SpawnSpeedCoil()
    -- hindari duplikat kalau sudah ada di Backpack atau Character
    if player:FindFirstChild("Backpack") then
        if player.Backpack:FindFirstChild("SpeedCoil") then
            return -- sudah ada
        end
    end
    if player.Character then
        if player.Character:FindFirstChild("SpeedCoil") then
            return -- sudah menempel di karakter
        end
    end

    -- buat tool dan isinya (mengikuti struktur skrip awal)
    local success, err = pcall(function()
        local mas = Instance.new("Model")
        local Tool0 = Instance.new("Tool")
        local Part2 = Instance.new("Part")
        local SpecialMesh3 = Instance.new("SpecialMesh")
        local Sound4 = Instance.new("Sound")

        Tool0.Name = "SpeedCoil"
        Tool0.Parent = mas
        Tool0.TextureId = "rbxassetid://99170415"
        Tool0.Grip = CFrame.new(0, 0, -0.8)
        Tool0.ToolTip = "Speed Up!"

        -- NOTE: kita tidak menaruh Script server-side di Tool; 
        -- sebelumnya fungsi effect di-bind di client via cors closure.
        -- Untuk kompatibilitas dengan implementasimu sebelumnya,
        -- kita tambahkan listener client-side yang mengubah WalkSpeed saat equip.

        -- Buat Handle (Part) & mesh & sound
        Part2.Name = "Handle"
        Part2.Parent = Tool0
        Part2.Size = Vector3.new(1,1,2)
        Part2.BottomSurface = Enum.SurfaceType.Smooth
        Part2.TopSurface = Enum.SurfaceType.Smooth

        SpecialMesh3.Parent = Part2
        SpecialMesh3.MeshId = "rbxassetid://16606212"
        SpecialMesh3.Scale = Vector3.new(0.7,0.7,0.7)
        SpecialMesh3.TextureId = "rbxassetid://99170547"
        SpecialMesh3.MeshType = Enum.MeshType.FileMesh

        Sound4.Name = "Equip"
        Sound4.Parent = Part2
        Sound4.SoundId = "rbxassetid://99173388"
        Sound4.Volume = 1

        -- Tambah behaviour client-side: boost speed on equip, restore on unequip
        -- (ini menggantikan Script server-side supaya efek bisa bekerja untuk client)
        local BOOST = 10
        do
            -- buat koneksi saat tool di-equip
            Tool0.Equipped:Connect(function()
                local character = Tool0.Parent
                local humanoid = character and character:FindFirstChildOfClass("Humanoid")
                if not humanoid then return end
                -- simpan last speed di Attribute supaya aman
                if humanoid:GetAttribute("SpeedCoil_LastSpeed") then return end
                humanoid:SetAttribute("SpeedCoil_LastSpeed", humanoid.WalkSpeed)
                humanoid.WalkSpeed = (humanoid.WalkSpeed or 16) + BOOST
                local handle = Tool0:FindFirstChild("Handle")
                if handle then
                    local s = handle:FindFirstChild("Equip")
                    if s and s:IsA("Sound") then
                        pcall(function() s:Play() end)
                    end
                end
            end)

            Tool0.Unequipped:Connect(function()
                local character = Tool0.Parent
                local humanoid = character and character:FindFirstChildOfClass("Humanoid")
                if not humanoid then return end
                local last = humanoid:GetAttribute("SpeedCoil_LastSpeed")
                if last then
                    humanoid.WalkSpeed = last
                    humanoid:SetAttribute("SpeedCoil_LastSpeed", nil)
                end
            end)
        end

        -- Pindahkan tool ke Backpack pemain (tunggu Backpack tersedia)
        local backpack = player:WaitForChild("Backpack", 5)
        -- final parent
        for i, v in pairs(mas:GetChildren()) do
            v.Parent = backpack
            pcall(function() v:MakeJoints() end)
        end
        mas:Destroy()
    end)

    if not success then
        warn("SpawnSpeedCoil gagal: ", err)
    end
end

-- Auto-spawn saat karakter terbentuk (respawn)
player.CharacterAdded:Connect(function(char)
    -- tunda kecil agar Backpack ter-attach
    task.wait(0.1)
    -- spawn-safe
    pcall(function() SpawnSpeedCoil() end)
end)

-- Jalankan segera kalau pemain sudah punya character
if player.Character then
    task.spawn(function()
        task.wait(0.1)
        pcall(function() SpawnSpeedCoil() end)
    end)
end

print("AutoSpawn SpeedCoil script aktif (client).")
